From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: AlphaKR93 <alphakr93@gmail.com>
Date: Tue, 14 Feb 2023 18:28:11 +0900
Subject: [PATCH] Port PaperMC/Paper#8845


diff --git a/src/main/java/net/minecraft/server/players/PlayerList.java b/src/main/java/net/minecraft/server/players/PlayerList.java
index 73aa6c7f14ea4417b131d9e8a627bc7617ad0f0f..1038a1b90b1e06c0d239b35820ab838f03a38ad7 100644
--- a/src/main/java/net/minecraft/server/players/PlayerList.java
+++ b/src/main/java/net/minecraft/server/players/PlayerList.java
@@ -933,8 +933,12 @@ public abstract class PlayerList {
         entityplayer1.setHealth(entityplayer1.getHealth());
         // Paper start - Fix SPIGOT-5989
         if (flag2 && !isLocAltered) {
+            // Andromeda start - Port PaperMC/Paper#8845
+            if (!team.earendel.andromeda.configurations.GlobalConfiguration.get().paperPullRequestsPort.fixForcedRespawnWithRespawnAnchor || !flag2) {
             BlockState data = worldserver1.getBlockState(blockposition);
             worldserver1.setBlock(blockposition, data.setValue(net.minecraft.world.level.block.RespawnAnchorBlock.CHARGE, data.getValue(net.minecraft.world.level.block.RespawnAnchorBlock.CHARGE) - 1), 3);
+            }
+            // Andromeda end
             entityplayer1.connection.send(new ClientboundSoundPacket(SoundEvents.RESPAWN_ANCHOR_DEPLETE, SoundSource.BLOCKS, (double) location.getX(), (double) location.getY(), (double) location.getZ(), 1.0F, 1.0F, worldserver1.getRandom().nextLong()));
         // Paper end
         }
diff --git a/src/main/java/team/earendel/andromeda/configurations/GlobalConfiguration.java b/src/main/java/team/earendel/andromeda/configurations/GlobalConfiguration.java
index 7ea1683eb6836f9ca812ae52582d64e0d404ae01..c6277d5067e02eb37b228e4866125a7e3a444c3f 100644
--- a/src/main/java/team/earendel/andromeda/configurations/GlobalConfiguration.java
+++ b/src/main/java/team/earendel/andromeda/configurations/GlobalConfiguration.java
@@ -173,6 +173,8 @@ public class GlobalConfiguration extends ConfigurationPart {
 
         public boolean fixChunkLoadingWhenTheRateIsSetToOne = true;
 
+        public boolean fixForcedRespawnWithRespawnAnchor = true;
+
     }
 
     public BugFixes bugFixes;
