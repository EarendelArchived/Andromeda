From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: AlphaKR93 <alphakr93@outlook.com>
Date: Sat, 7 Jan 2023 22:58:54 +0900
Subject: [PATCH] Port PaperMC/Paper#8602


diff --git a/src/main/java/net/minecraft/commands/CommandSourceStack.java b/src/main/java/net/minecraft/commands/CommandSourceStack.java
index 613b3fb0a90ef19161f0df09a014c3811e5b8c9e..1feaaa2b8958b12462b0f7f0398ee1cc30c19a70 100644
--- a/src/main/java/net/minecraft/commands/CommandSourceStack.java
+++ b/src/main/java/net/minecraft/commands/CommandSourceStack.java
@@ -207,8 +207,20 @@ public class CommandSourceStack implements SharedSuggestionProvider, com.destroy
 
     // CraftBukkit start
     public boolean hasPermission(int i, String bukkitPermission) {
-        // World is null when loading functions
-        return ((this.getLevel() == null || !this.getLevel().getCraftServer().ignoreVanillaPermissions) && this.permissionLevel >= i) || this.getBukkitSender().hasPermission(bukkitPermission);
+        // Andromeda start - Port PaperMC/Paper#8602
+        Boolean flag = true;
+        try {
+            flag = team.earendel.andromeda.configurations.GlobalConfiguration.get().paperPullRequestsPort.fixCommandFunctionPermChecking.enabled;
+        } catch (Exception ignored) {
+            ;
+        }
+        if (flag)
+            return ((this.getLevel() == null || !this.getLevel().getCraftServer().ignoreVanillaPermissions) && this.permissionLevel >= i) || this.getBukkitSender().hasPermission(bukkitPermission);
+        if (this.source == CommandSource.NULL)
+            return this.permissionLevel >= i;
+        else
+            return (!this.getLevel().getCraftServer().ignoreVanillaPermissions && this.permissionLevel >= i) || this.getBukkitSender().hasPermission(bukkitPermission);
+        // Andromeda end
     }
     // CraftBukkit end
 
diff --git a/src/main/java/team/earendel/andromeda/configurations/GlobalConfiguration.java b/src/main/java/team/earendel/andromeda/configurations/GlobalConfiguration.java
index e4644ee4551d723c7cb6e273ba2af761211695d1..10537599d0c634c7d790b28d2c0d8906ea99aa4a 100644
--- a/src/main/java/team/earendel/andromeda/configurations/GlobalConfiguration.java
+++ b/src/main/java/team/earendel/andromeda/configurations/GlobalConfiguration.java
@@ -150,6 +150,13 @@ public class GlobalConfiguration extends ConfigurationPart {
 
         }
 
+        public FixCommandFunctionPermChecking fixCommandFunctionPermChecking;
+        public class FixCommandFunctionPermChecking extends ConfigurationPart {
+
+            public boolean enabled = true;
+
+        }
+
     }
 
 }
