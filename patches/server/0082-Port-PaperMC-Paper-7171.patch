From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: AlphaKR93 <alphakr93@outlook.com>
Date: Fri, 13 Jan 2023 20:31:40 +0900
Subject: [PATCH] Port PaperMC/Paper#7171


diff --git a/src/main/java/net/minecraft/world/level/Explosion.java b/src/main/java/net/minecraft/world/level/Explosion.java
index a8c878ed70845a417b8d892ff1aea1baceddb43b..32cbc3e5ad030a6ea04ae8034a5510b6cc633359 100644
--- a/src/main/java/net/minecraft/world/level/Explosion.java
+++ b/src/main/java/net/minecraft/world/level/Explosion.java
@@ -287,11 +287,26 @@ public class Explosion {
                             d14 = entity instanceof Player && level.paperConfig().environment.disableExplosionKnockback ? 0 : ProtectionEnchantment.getExplosionKnockbackAfterDampener((LivingEntity) entity, d13); // Paper - Disable explosion knockback
                         }
 
+                        // Andromeda start - Port PaperMC/Paper#7171
+                        org.bukkit.util.Vector delta = null;
+                        if (this.level.andromedaLevelConfiguration().paperPullRequestsPort.fireEntityKnockbackEventForOwnerlessTnt) {
+                            delta = new org.bukkit.util.Vector(d8 * d14, d9 * d14, d10 * d14);
+                            if (this.source != null && this.damageSource.getEntity() == null && entity instanceof LivingEntity livingEntity)
+                                if (!new com.destroystokyo.paper.event.entity.EntityKnockbackByEntityEvent(livingEntity.getBukkitLivingEntity(), this.source.getBukkitEntity(), (float) d14, delta).callEvent())
+                                    return;
+                            entity.setDeltaMovement(entity.getDeltaMovement().add(delta.getX(), delta.getY(), delta.getZ()));
+                        } else
+                        // Andromeda end
                         entity.setDeltaMovement(entity.getDeltaMovement().add(d8 * d14, d9 * d14, d10 * d14));
                         if (entity instanceof Player) {
                             Player entityhuman = (Player) entity;
 
                             if (!entityhuman.isSpectator() && (!entityhuman.isCreative() || !entityhuman.getAbilities().flying) && !level.paperConfig().environment.disableExplosionKnockback) { // Paper - Disable explosion knockback
+                                // Andromeda start - Port PaperMC/Paper#7171
+                                if (this.level.andromedaLevelConfiguration().paperPullRequestsPort.fireEntityKnockbackEventForOwnerlessTnt)
+                                    this.hitPlayers.put(entityhuman, org.bukkit.craftbukkit.util.CraftVector.toNMS(delta));
+                                else
+                                // Andromeda end
                                 this.hitPlayers.put(entityhuman, new Vec3(d8 * d13, d9 * d13, d10 * d13));
                             }
                         }
diff --git a/src/main/java/team/earendel/andromeda/configurations/LevelConfigurations.java b/src/main/java/team/earendel/andromeda/configurations/LevelConfigurations.java
index 05ae089b938e7e11d55105a86f46c8d5f0990ad4..ba598c5d9a6875b80ed007234700520f76a52e5d 100644
--- a/src/main/java/team/earendel/andromeda/configurations/LevelConfigurations.java
+++ b/src/main/java/team/earendel/andromeda/configurations/LevelConfigurations.java
@@ -189,6 +189,8 @@ public class LevelConfigurations extends ConfigurationPart {
 
         public boolean fixHumanEntityDropNotUpdatingTheClientInventory = true;
 
+        public boolean fireEntityKnockbackEventForOwnerlessTnt = true;
+
     }
 
 }
